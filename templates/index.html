<!DOCTYPE html>
<html lang="en" class="darkMode">
<head>
  <meta charset="UTF-8">
  <title>Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

</head>
<body class="bg-gray-900 text-white">
  <h1 class="text-3xl font-bold mb-6 text-center">Chat with AI</h1>
  <div class="text-center mb-4">
    <input type="text" id="messageInput" placeholder="Enter your message" class="bg-gray-800 text-white border border-gray-600 px-3 py-2 rounded placeholder-gray-400">
    <button onclick="sendMessage()" id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Send</button>
    <button onclick="startRecording()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Start Recording</button>
    <button onclick="stopRecording()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Stop & Upload</button>
    <audio id="audioPlayback" controls></audio>
  </div>

  <div id="loadingSpinner" class="hidden text-center mb-4">
    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
    <p class="text-gray-400 mt-2">AI is thinking...</p>
  </div>

  <div id="response" class="mt-6 p-4 bg-gray-800 border border-gray-600 rounded-lg min-h-[200px]"></div>

  <script>

    let mediaRecorder;
    let audioChunks = [];

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          audioChunks = [];

          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };
        });
    }

    function stopRecording() {
      mediaRecorder.stop();
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioURL = URL.createObjectURL(audioBlob);
        document.getElementById('audioPlayback').src = audioURL;

        const formData = new FormData();
        formData.append('file', audioBlob, 'speech.wav');

        fetch('/upload_audio', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => alert('Transcript: ' + data.transcript))
        .catch(err => console.error('Error:', err));
      };
    }
    
    function showLoading() {
      document.getElementById('loadingSpinner').classList.remove('hidden');
      document.getElementById('sendButton').disabled = true;
      document.getElementById('sendButton').textContent = 'Sending...';
    }
    
    function hideLoading() {
      document.getElementById('loadingSpinner').classList.add('hidden');
      document.getElementById('sendButton').disabled = false;
      document.getElementById('sendButton').textContent = 'Send';
    }

    async function sendMessage() {
      let input = document.getElementById("messageInput");
      let message = input.value;
      let responseDiv = document.getElementById("response");

      input.value = '';

      showLoading();

      try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        const data = await res.json();
        if (data.response) {
            responseDiv.textContent = "Bot: " + data.response;
        } else {
            responseDiv.textContent = "Error: " + (data.error || "Unknown error");
        }
      } catch (error) {
        responseDiv.textContent = "Error: Network error or server unavailable";
        console.error('Fetch error:', error);
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
