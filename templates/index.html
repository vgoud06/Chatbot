<!DOCTYPE html>
<html lang="en" class="darkMode">
<head>
  <meta charset="UTF-8">
  <title>Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

</head>
<body class="bg-gray-900 text-white">
  <h1 class="text-3xl font-bold mb-6 text-center">Chat with AI</h1>
  <div class="text-center mb-4">
    <input type="text" id="messageInput" placeholder="Enter your message" class="bg-gray-800 text-white border border-gray-600 px-3 py-2 rounded placeholder-gray-400">
    <button onclick="sendMessage()" id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Send</button>
    <button onclick="toggleVoiceRecording()" id="voiceButton" class="bg-blue-600 hover:bg-purple-700 text-white px-4 py-2 rounded mr-2">Record</button>
    <button onclick="toggleAutoSpeak()" id="autoSpeakButton" class="bg-blue-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Auto-speak</button>
  </div>

  <div id="loadingSpinner" class="hidden text-center mb-4">
    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
    <p class="text-gray-400 mt-2">AI is thinking...</p>
  </div>

  <div id="response" class="mt-6 p-4 bg-gray-800 border border-gray-600 rounded-lg min-h-[200px]"></div>

  <script>

let recognition = null;
    let isRecording = false;
    let autoSpeak = false;
    
    // Initialize speech recognition
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
          isRecording = true;
          document.getElementById('voiceButton').textContent = 'Stop';
          document.getElementById('voiceButton').className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded mr-2';
        };
        
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('messageInput').value = transcript;
          sendMessage();
        };
        
        recognition.onend = function() {
          isRecording = false;
          document.getElementById('voiceButton').textContent = 'Speak';
          document.getElementById('voiceButton').className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mr-2';
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          isRecording = false;
          document.getElementById('voiceButton').textContent = 'Speak';
          document.getElementById('voiceButton').className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mr-2';
        };
      } else {
        console.warn('Speech recognition not supported in this browser');
        document.getElementById('voiceButton').disabled = true;
        document.getElementById('voiceButton').textContent = 'Not supported';
      }
    }
    
    // Toggle voice recording
    function toggleVoiceRecording() {
      if (!recognition) {
        alert('Speech recognition not supported in this browser');
        return;
      }
      
      if (isRecording) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }
    
    // Toggle auto-speak feature
    function toggleAutoSpeak() {
      autoSpeak = !autoSpeak;
      const button = document.getElementById('autoSpeakButton');
      if (autoSpeak) {
        button.textContent = 'Auto-speak ON';
        button.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded';
      } else {
        button.textContent = 'Auto-speak';
        button.className = 'bg-blue-600 hover:bg-purple-700 text-white px-4 py-2 rounded';
      }
    }
    
    // Text-to-speech function
    function speakText(text) {
      if ('speechSynthesis' in window) {
        // Stop any current speech
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        // Try to use a more natural voice
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => 
          voice.name.includes('Google') || 
          voice.name.includes('Microsoft') ||
          voice.lang.startsWith('en')
        );
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }
        
        speechSynthesis.speak(utterance);
      } else {
        console.warn('Text-to-speech not supported in this browser');
      }
    }
    
    function showLoading() {
      document.getElementById('loadingSpinner').classList.remove('hidden');
      document.getElementById('sendButton').disabled = true;
      document.getElementById('sendButton').textContent = 'Sending...';
    }
    
    function hideLoading() {
      document.getElementById('loadingSpinner').classList.add('hidden');
      document.getElementById('sendButton').disabled = false;
      document.getElementById('sendButton').textContent = 'Send';
    }

    async function sendMessage() {
      let input = document.getElementById("messageInput");
      let message = input.value;
      let responseDiv = document.getElementById("response");

      input.value = '';

      showLoading();

      try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        const data = await res.json();
        if (data.response) {
            responseDiv.textContent = "Bot: " + data.response;
        } else {
            responseDiv.textContent = "Error: " + (data.error || "Unknown error");
        }
      } catch (error) {
        responseDiv.textContent = "Error: Network error or server unavailable";
        console.error('Fetch error:', error);
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
